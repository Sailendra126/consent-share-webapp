<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Streaming Test</title>
  <style>
    body { margin:0; background:#0b1020; color:#e5f4ff; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    video { width: 100%; max-height: 45vh; background:#000; border-radius:12px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    button { padding: 8px 16px; background: #1e40af; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 4px; }
    .log { background: #1f2937; padding: 16px; border-radius: 8px; margin: 16px 0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Streaming Test Page</h2>
    
    <div>
      <button id="testCamera">Test Camera Access</button>
      <button id="testWebSocket">Test WebSocket</button>
      <button id="testStreaming">Test Streaming</button>
      <button id="clearLog">Clear Log</button>
    </div>
    
    <div class="row">
      <video id="localVideo" autoplay playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
    
    <div id="log" class="log"></div>
  </div>

  <script>
    // --- Screen Wake Lock (keep screen on while testing) ---
    let wakeLock = null;
    let wakeFallbackVideo = null;

    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator && navigator.wakeLock?.request) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener?.('release', () => addLog('Wake Lock released'));
          addLog('Screen Wake Lock acquired');
        } else {
          if (!wakeFallbackVideo) {
            wakeFallbackVideo = document.createElement('video');
            wakeFallbackVideo.setAttribute('playsinline', '');
            wakeFallbackVideo.muted = true;
            wakeFallbackVideo.loop = true;
            wakeFallbackVideo.style.position = 'fixed';
            wakeFallbackVideo.style.width = '1px';
            wakeFallbackVideo.style.height = '1px';
            wakeFallbackVideo.style.opacity = '0';
            const c = document.createElement('canvas');
            c.width = 1; c.height = 1;
            const stream = c.captureStream?.(1);
            if (stream) {
              wakeFallbackVideo.srcObject = stream;
              await wakeFallbackVideo.play().catch(()=>{});
              addLog('Wake Lock fallback active');
            }
          } else {
            await wakeFallbackVideo.play().catch(()=>{});
          }
        }
      } catch (e) {
        addLog(`Wake Lock failed: ${e?.message || e}`);
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') requestWakeLock();
    });

    const wakeOnFirstInteraction = () => {
      requestWakeLock();
      document.removeEventListener('click', wakeOnFirstInteraction);
      document.removeEventListener('touchstart', wakeOnFirstInteraction);
    };
    document.addEventListener('click', wakeOnFirstInteraction, { once: true });
    document.addEventListener('touchstart', wakeOnFirstInteraction, { once: true });
    const log = document.getElementById('log');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    
    function addLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      log.innerHTML += `[${timestamp}] ${message}<br>`;
      log.scrollTop = log.scrollHeight;
      console.log(message);
    }
    
    let ws = null;
    let localStream = null;
    
    // Test camera access
    document.getElementById('testCamera').addEventListener('click', async () => {
      requestWakeLock();
      addLog('Testing camera access...');
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'user',
            width: { ideal: 640 },
            height: { ideal: 480 }
          }, 
          audio: false 
        });
        
        localVideo.srcObject = localStream;
        addLog('âœ“ Camera access granted');
        addLog(`Stream tracks: ${localStream.getTracks().length}`);
        addLog(`Video dimensions: ${localVideo.videoWidth}x${localVideo.videoHeight}`);
      } catch (error) {
        addLog(`âœ— Camera access denied: ${error.message}`);
      }
    });
    
    // Test WebSocket connection
    document.getElementById('testWebSocket').addEventListener('click', () => {
      requestWakeLock();
      addLog('Testing WebSocket connection...');
      
      const room = 'test-streaming';
      const protocol = location.protocol.startsWith('https') ? 'wss' : 'ws';
      const wsUrl = `${protocol}://${location.host}/ws?room=${encodeURIComponent(room)}`;
      
      addLog(`Connecting to: ${wsUrl}`);
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        addLog('âœ“ WebSocket connected');
        
        // Send test message
        ws.send(JSON.stringify({
          type: 'test_message',
          room: room,
          device: 'test-client',
          message: 'WebSocket test',
          timestamp: Date.now()
        }));
        addLog('âœ“ Test message sent');
      };
      
      ws.onmessage = (ev) => {
        try {
          const data = JSON.parse(ev.data);
          addLog(`ðŸ“¨ Received: ${data.type || 'unknown'}`);
        } catch (error) {
          addLog(`ðŸ“¨ Received raw: ${ev.data}`);
        }
      };
      
      ws.onerror = (error) => {
        addLog(`âœ— WebSocket error: ${error}`);
      };
      
      ws.onclose = () => {
        addLog('ðŸ”Œ WebSocket closed');
      };
    });
    
    // Test streaming
    document.getElementById('testStreaming').addEventListener('click', () => {
      requestWakeLock();
      if (!localStream) {
        addLog('âœ— No camera stream available. Test camera first.');
        return;
      }
      
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        addLog('âœ— WebSocket not connected. Test WebSocket first.');
        return;
      }
      
      addLog('Testing video streaming...');
      
      // Create canvas to capture frames
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const video = document.createElement('video');
      video.srcObject = localStream;
      video.muted = true;
      video.play();
      
      canvas.width = 320;
      canvas.height = 240;
      
      let frameCount = 0;
      const maxFrames = 10; // Send only 10 frames for testing
      
      const captureFrame = () => {
        if (frameCount >= maxFrames) {
          addLog(`âœ“ Streaming test completed (${frameCount} frames sent)`);
          return;
        }
        
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = canvas.toDataURL('image/jpeg', 0.8);
          
          frameCount++;
          
          const frameData = {
            type: 'video_frame',
            camera: 'front',
            room: 'test-streaming',
            data: imageData,
            timestamp: Date.now(),
            frameCount: frameCount
          };
          
          ws.send(JSON.stringify(frameData));
          addLog(`ðŸ“¹ Sent frame ${frameCount}/${maxFrames}`);
          
          setTimeout(captureFrame, 100); // Send frame every 100ms
        } else {
          requestAnimationFrame(captureFrame);
        }
      };
      
      video.onloadedmetadata = () => {
        addLog('Video ready, starting frame capture...');
        captureFrame();
      };
    });
    
    // Clear log
    document.getElementById('clearLog').addEventListener('click', () => {
      log.innerHTML = '';
    });
    
    // Initialize
    addLog('Streaming test page loaded');
    requestWakeLock();
    addLog(`User Agent: ${navigator.userAgent}`);
    addLog(`Touch Points: ${navigator.maxTouchPoints}`);
    addLog(`Is Mobile: ${/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (navigator.maxTouchPoints && navigator.maxTouchPoints > 2)}`);
  </script>
</body>
</html>
