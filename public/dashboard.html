<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <title>Live Shares Dashboard</title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0b1020; color: #e5f4ff; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    .panel { background: #141a2d; border: 1px solid #1f2a44; border-radius: 12px; padding: 16px; margin-top: 16px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; border-bottom: 1px solid #1f2a44; padding: 8px; font-size: 14px; }
    a { color: #22d3ee; }
    .muted { color: #9fb2cc; }
  </style>
  <meta name="color-scheme" content="light dark" />
</head>
<body>
  <div class="wrap">
    <h1>Live Shares</h1>
    <div class="muted">Paginated view. Newest first. Click Refresh to update.</div>
    <div style="margin:8px 0; display:flex; gap:8px; align-items:center;">
      <button id="logout">Logout</button>
      <button id="refresh">Refresh</button>
      <span id="authMsg" class="muted"></span>
    </div>
    <div style="margin:8px 0; display:flex; gap:8px; align-items:center;">
      <button id="prev">Prev</button>
      <button id="next">Next</button>
      <span id="pageInfo" class="muted"></span>
    </div>
    <div id="status" class="muted" style="margin-top:8px;">Loading…</div>

    <div class="panel">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>When</th>
            <th>Lat</th>
            <th>Lng</th>
            <th>Acc (m)</th>
            <th>Name</th>
            <th>Device / UA</th>
            <th>IP</th>
            <th>Page</th>
            <th>Map</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div id="updated" class="muted">Updated: —</div>
  </div>

  <script>
    const tbody = document.getElementById('tbody');
    const status = document.getElementById('status');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const pageInfo = document.getElementById('pageInfo');
    const logoutBtn = document.getElementById('logout');
    const refreshBtn = document.getElementById('refresh');
    const authMsg = document.getElementById('authMsg');
    const updatedEl = document.getElementById('updated');
    let currentPage = 1;
    const pageSize = 50;

    async function logout() {
      try { await fetch('/api/logout', { method: 'POST' }); authMsg.textContent = 'Logged out'; setTimeout(()=>location.href='/login.html', 300); }
      catch { authMsg.textContent = 'Logout failed'; }
    }
    logoutBtn.addEventListener('click', logout);

    function deviceLabel(rec) {
      const d = rec.deviceSummary || rec.device || {};
      const brands = Array.isArray(d.brands)
        ? d.brands.map(b => `${b.brand}${b.version ? ' ' + b.version : ''}`).join(', ')
        : (d.brand || '');
      const plat = d.platformHint || d.platform || '';
      const mobile = typeof d.mobile === 'boolean' ? (d.mobile ? 'Mobile' : 'Desktop') : (d.isMobile ? 'Mobile' : '');
      const ua = rec.userAgent || d.userAgent || '';
      return [brands, plat, mobile, ua].filter(Boolean).join(' · ') || '—';
    }

    function mapLink(lat, lng) {
      if (typeof lat !== 'number' || typeof lng !== 'number') return '—';
      const url = `https://www.google.com/maps?q=${lat},${lng}`;
      return `<a href="${url}" target="_blank" rel="noopener">Open</a>`;
    }

    async function load() {
      try {
        status.textContent = 'Updating…';
        const res = await fetch(`/admin/recent?page=${currentPage}&pageSize=${pageSize}`, { cache: 'no-store' });
        if (res.status === 401) { window.location.href = '/login.html'; return; }
        const data = await res.json();
        const rows = data.items || [];
        const total = data.total || rows.length;
        pageInfo.textContent = `Page ${currentPage} · ${rows.length} items · Total ${total}`;
        tbody.innerHTML = rows.map((r, idx) => {
          const serial = (currentPage - 1) * pageSize + idx + 1;
          const when = r.receivedAtIso ? new Date(r.receivedAtIso).toLocaleString(undefined, { hour12: false, timeZoneName: 'short' }) : '—';
          const lat = r.gps && typeof r.gps.latitude === 'number' ? r.gps.latitude.toFixed(6) : '—';
          const lng = r.gps && typeof r.gps.longitude === 'number' ? r.gps.longitude.toFixed(6) : '—';
          const acc = r.gps && r.gps.accuracyMeters != null ? Math.round(r.gps.accuracyMeters) : '—';
          const dev = deviceLabel(r);
          const name = r.playerName || '—';
          const ip = r.ip || '—';
          const page = r.page || '—';
          const map = mapLink(r?.gps?.latitude, r?.gps?.longitude);
          return `<tr><td>${serial}</td><td>${when}</td><td>${lat}</td><td>${lng}</td><td>${acc}</td><td>${name}</td><td>${dev}</td><td>${ip}</td><td>${page}</td><td>${map}</td></tr>`;
        }).join('');
        const stamp = new Date().toLocaleString(undefined, { hour12: false, timeZoneName: 'short' });
        updatedEl.textContent = `Refreshed: ${stamp}`;
        status.textContent = '';
      } catch (e) {
        status.textContent = 'Failed to load';
      }
    }

    load();
    refreshBtn.addEventListener('click', load);

    prevBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage -= 1; load(); } });
    nextBtn.addEventListener('click', () => { currentPage += 1; load(); });
  </script>
</body>
</html>


