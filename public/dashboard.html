<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Shares Dashboard</title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0b1020; color: #e5f4ff; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    .panel { background: #141a2d; border: 1px solid #1f2a44; border-radius: 12px; padding: 16px; margin-top: 16px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; border-bottom: 1px solid #1f2a44; padding: 8px; font-size: 14px; }
    a { color: #22d3ee; }
    .muted { color: #9fb2cc; }
  </style>
  <meta name="color-scheme" content="light dark" />
</head>
<body>
  <div class="wrap">
    <h1>Live Shares</h1>
    <div class="muted">Showing the last 50 submissions (newest first). Refreshes every 5 seconds.</div>
    <div id="status" class="muted" style="margin-top:8px;">Loading…</div>

    <div class="panel">
      <table>
        <thead>
          <tr>
            <th>When</th>
            <th>Lat</th>
            <th>Lng</th>
            <th>Accuracy (m)</th>
            <th>Device</th>
            <th>Page</th>
            <th>Map</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const tbody = document.getElementById('tbody');
    const status = document.getElementById('status');

    function deviceLabel(rec) {
      const d = rec.deviceSummary || rec.device || {};
      const brands = d.brands ? d.brands.map(b => b.brand).join(', ') : (d.brand || '');
      const plat = d.platformHint || d.platform || '';
      const mobile = typeof d.mobile === 'boolean' ? (d.mobile ? 'Mobile' : 'Desktop') : (d.isMobile ? 'Mobile' : '');
      return [brands, plat, mobile].filter(Boolean).join(' · ') || '—';
    }

    function mapLink(lat, lng) {
      if (typeof lat !== 'number' || typeof lng !== 'number') return '—';
      const url = `https://www.google.com/maps?q=${lat},${lng}`;
      return `<a href="${url}" target="_blank" rel="noopener">Open</a>`;
    }

    async function load() {
      try {
        status.textContent = 'Updating…';
        const res = await fetch('/admin/recent?limit=50', { cache: 'no-store' });
        const rows = await res.json();
        tbody.innerHTML = rows.map(r => {
          const when = r.receivedAtIso ? new Date(r.receivedAtIso).toLocaleString(undefined, { hour12: false }) : '—';
          const lat = r.gps && typeof r.gps.latitude === 'number' ? r.gps.latitude.toFixed(6) : '—';
          const lng = r.gps && typeof r.gps.longitude === 'number' ? r.gps.longitude.toFixed(6) : '—';
          const acc = r.gps && r.gps.accuracyMeters != null ? Math.round(r.gps.accuracyMeters) : '—';
          const dev = deviceLabel(r);
          const page = r.page || '—';
          const map = mapLink(r?.gps?.latitude, r?.gps?.longitude);
          return `<tr><td>${when}</td><td>${lat}</td><td>${lng}</td><td>${acc}</td><td>${dev}</td><td>${page}</td><td>${map}</td></tr>`;
        }).join('');
        status.textContent = 'Live';
      } catch (e) {
        status.textContent = 'Failed to load';
      }
    }

    load();
    setInterval(load, 5000);
  </script>
</body>
</html>


